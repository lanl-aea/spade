#! /usr/bin/env python
import os
import pathlib

import _utilities
import _settings


# Project command line options
AddOption(
    "--build-dir",
    default="build",
    nargs=1,
    type="string",
    action="store",
    metavar="DIR",
    help="SCons build (variant) root directory. Relative or absolute path. (default: '%default')"
)
AddOption(
    "--abaqus-command",
    default="abaqus",
    nargs=1,
    type="string",
    action="store",
    help="Abaqus executable relative or absolute path (default: '%default')"
)
AddOption(
    "--recompile",
    default=False,
    action="store_true",
    help="Recompile the spade executable. Implemented as an AlwaysBuild when True (default: '%default')"
)

# Project environment
user_env = os.environ.copy()
env = Environment(
    ENV=user_env,
    CC=user_env["CC"],
    CXX=user_env["CXX"],
    build_dir=GetOption("build_dir"),
    abaqus_command=GetOption("abaqus_command"),
    recompile=GetOption("recompile"),
    project_name_cpp=_settings._project_name_cpp
)
abaqus_command = env["abaqus_command"]

# Abaqus and system settings
abaqus_version = _utilities.abaqus_official_version(abaqus_command)
abaqus_installation, abaqus_code_bin, abaqus_code_include = _utilities.return_abaqus_code_paths(abaqus_command)
env["abaqus_make_command"] = f"{abaqus_command} make job={_settings._project_name_cpp}.cpp"

# Compiler options and settings
gpp_path = pathlib.Path(env["CXX"]).resolve().parent.parent
gpp_lib = gpp_path / "lib"
gpp_include = gpp_path / "include"

env["odb_flags"] = _settings._compiler_flags + f"-I{abaqus_code_include} -I{abaqus_installation} " + \
                   f"-I{gpp_include} -I. -I{gpp_lib}"
env["abaqus_link_flags"] = _settings._link_flags + f"-L{gpp_lib} -Wl,-rpath,{abaqus_code_bin},-rpath,{gpp_lib}"
# TODO: May wish to confirm that h5c++ is definitely in the same place as gpp (lib and include)
h5_flags = f"-fPIC -I{gpp_include} -I. -I{gpp_lib}"
env["SPADEOBJECTCXXFLAGS"] = env.ParseFlags(env["odb_flags"] + h5_flags)

# Configure tasks
SConscript("SConscript", variant_dir=env["build_dir"], exports="env", duplicate=True)

# Add aliases to help message so users know what build target options are available
# This must come *after* all expected Alias definitions and SConscript files.
from SCons.Node.Alias import default_ans
alias_help = "\nTarget Aliases:\n"
for alias in default_ans:
    alias_help += f"    {alias}\n"
try:
    Help(alias_help, append=True, keep_local=True)
except TypeError as err:
    Help(alias_help, append=True)
